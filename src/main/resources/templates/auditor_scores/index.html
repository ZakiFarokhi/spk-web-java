<!DOCTYPE html>
<html layout:decorate="~{shared/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <!--    <title th:text="'Penilaian Kriteria: ' + ${criteria.name}"></title>-->
    <style>
        table.table-hover tbody tr:hover {
            background-color: #f7f7f7;
        }

        td,
        th {
            vertical-align: middle !important;
        }

        .card {
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            background: #3c8dbc;
            color: white;
            border-radius: 12px 12px 0 0 !important;
        }
    </style>
</head>

<body>
<th:block layout:fragment="content">
    <div>
        <section class="content pt-3">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <!--                        <h3 class="card-title m-0">üìù Penilaian Auditor: <span th:text="${criteria.name}"></span></h3>-->
                    </div>

                    <div class="card-body">

                        <div th:if="${successMessage}" class="alert alert-success">
                            <p th:text="${successMessage}"></p>
                        </div>
                        <div th:if="${errorMessage}" class="alert alert-danger">
                            <p th:text="${errorMessage}"></p>
                        </div>

                        <div class="bg-info text-white p-3 mb-4 rounded d-flex justify-content-between align-items-center">
                            <h4 class="m-0">
                                Kriteria: <span th:text="${criteria.code} + ' - ' + ${criteria.name}">K1 - Kompetensi</span>
                            </h4>
                            <span class="badge bg-light text-dark fs-6"
                                  th:text="'Bobot: ' + ${#numbers.formatDecimal(criteria.bobot, 1, 2)}">Bobot: 0.3</span>
                        </div>


                        <div th:unless="${isGenerated}" class="text-center p-5 border rounded">
                            <h4 class="text-danger">Data Penilaian Belum Tersedia</h4>
                            <p>Untuk kriteria <strong><span th:text="${criteria.name}"></span></strong>, kerangka penilaian belum
                                dibuat. Klik tombol di bawah ini untuk membuat data default (nilai awal 0.0) bagi semua auditor.</p>

                            <form th:action="@{/auditor-scores/generate/{id}(id=${criteriaId})}" method="post" class="mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-cogs"></i> Generate Data Penilaian
                                </button>
                            </form>
                        </div>

                        <div th:if="${isGenerated}">
                            <p class="alert alert-info">Matriks penilaian sudah terbentuk. Nilai yang ditampilkan adalah nilai
                                mentah (Raw Value) yang tersimpan.</p>

                            <th:block th:with="scoreMap=${scoreMap}">

                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover mt-2">
                                        <thead>
                                        <tr class="bg-light text-center">
                                            <th style="width: 50px;">ID</th>
                                            <th style="min-width: 120px;">Nama Auditor</th>

                                            <th th:each="sc : ${subCriteriaList}" th:text="${sc.code} + ' - ' + ${sc.name}"
                                                style="min-width: 150px;">
                                                SK1 - Sub Kriteria
                                            </th>
                                            <th sec:authorize="hasRole('ADMIN')">Aksi</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="auditor : ${auditors}">

                                            <form th:action="@{/auditor-scores/update-row}" method="POST">

                                                <td th:text="${auditor.id}">1</td>
                                                <td th:text="${auditor.name}">Nama Auditor A</td>

                                                <th:block th:each="sc : ${subCriteriaList}">
                                                    <td sec:authorize="hasRole('ADMIN')" class="text-center">
                                                        <th:block th:with="scoreKey=${auditor.id + '_' + sc.id}, currentScore=${scoreMap.get(scoreKey)}">

                                                            <input type="hidden" th:name="'scoreIds[' + ${currentScore.id} + ']'"
                                                                   th:value="${currentScore.id}" />

                                                            <select class="form-control form-control-sm"
                                                                    th:name="'cripsIds[' + ${currentScore.id} + ']'"
                                                                    required style="min-width: 120px; display: inline-block;">

                                                                <option value="">-- Pilih Nilai --</option>

                                                                <th:block th:each="crips : ${allCrips}">
                                                                    <th:block th:if="${crips.subCriteria.id == sc.id}">
<!--                                                                        <option th:value="${crips.id}" th:text="${crips.description}">test</option>-->

                                                                        <option th:value="${crips.id}"
                                                                                th:text="${crips.description} + ' (' + ${#numbers.formatDecimal(crips.nilai, 1, 2)} + ')'"
                                                                                th:selected="${currentScore != null and currentScore.crips != null and currentScore.crips.id == crips.id}">
                                                                            Crips Description (Value)
                                                                        </option>
                                                                    </th:block>
                                                                </th:block>
                                                            </select>
                                                        </th:block>
                                                    </td>
                                                    <td class="text-center" sec:authorize="hasRole('USER')">
                                                        <th:block th:with="scoreKey=${auditor.id + '_' + sc.id}, currentScore=${scoreMap.get(scoreKey)}">

                                                            <input type="hidden" th:name="'scoreIds[' + ${currentScore.id} + ']'"
                                                                   th:value="${currentScore.id}" />

                                                            <select class="form-control form-control-sm"
                                                                    th:name="'cripsIds[' + ${currentScore.id} + ']'"
                                                                    required style="min-width: 120px; display: inline-block;" disabled>

                                                                <option value="">-- Pilih Nilai --</option>

                                                                <th:block th:each="crips : ${allCrips}">
                                                                    <th:block th:if="${crips.subCriteria.id == sc.id}">
                                                                        <!--                                                                        <option th:value="${crips.id}" th:text="${crips.description}">test</option>-->

                                                                        <option th:value="${crips.id}"
                                                                                th:text="${crips.description} + ' (' + ${#numbers.formatDecimal(crips.nilai, 1, 2)} + ')'"
                                                                                th:selected="${currentScore != null and currentScore.crips != null and currentScore.crips.id == crips.id}">
                                                                            Crips Description (Value)
                                                                        </option>
                                                                    </th:block>
                                                                </th:block>
                                                            </select>
                                                        </th:block>
                                                    </td>
                                                </th:block>

                                                <td sec:authorize="hasRole('ADMIN')" class="text-center">
                                                    <input type="hidden" name="auditorId" th:value="${auditor.id}" />
                                                    <input type="hidden" name="criteriaId" th:value="${criteriaId}" />

                                                    <button class="btn btn-warning btn-sm" type="submit">
                                                        <i class="fas fa-edit"></i> Update
                                                    </button>
                                                </td>
                                            </form>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</th:block>

</body>

</html>